---
# DNS Secondary Tasks

- name: Install BIND9 packages
  apt:
    name: "{{ dns_packages }}"
    state: present
    update_cache: yes
  tags:
    - dns
    - packages

- name: Create DNS log directory
  file:
    path: "{{ dns_log_dir }}"
    state: directory
    owner: bind
    group: bind
    mode: '0755'
  tags:
    - dns
    - directories

- name: Configure named.conf.options
  template:
    src: named.conf.options.j2
    dest: "{{ dns_conf_dir }}/named.conf.options"
    owner: root
    group: bind
    mode: '0644'
    backup: yes
    validate: 'named-checkconf %s'
  notify: restart bind9
  tags:
    - dns
    - config

- name: Configure named.conf.local (secondary)
  template:
    src: named.conf.local.j2
    dest: "{{ dns_conf_dir }}/named.conf.local"
    owner: root
    group: bind
    mode: '0644'
    backup: yes
    validate: 'named-checkconf %s'
  notify: restart bind9
  tags:
    - dns
    - config

- name: Ensure bind cache directory permissions
  file:
    path: "{{ dns_cache_dir }}"
    state: directory
    owner: bind
    group: bind
    mode: '0755'
  tags:
    - dns
    - directories

- name: Ensure BIND9 is enabled and started
  service:
    name: "{{ dns_service }}"
    state: started
    enabled: yes
  tags:
    - dns
    - service

- name: Configure AppArmor for BIND9
  shell: |
    if [ -f /etc/apparmor.d/usr.sbin.named ]; then
      aa-complain /usr/sbin.named || true
    fi
  changed_when: false
  tags:
    - dns
    - security

- name: Wait for zone transfer
  wait_for:
    path: "{{ dns_cache_dir }}/db.{{ dns_domain }}"
    timeout: 60
  tags:
    - dns
    - zones
